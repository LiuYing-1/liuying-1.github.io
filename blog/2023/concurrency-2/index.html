<!DOCTYPE html> <html> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta name="google-site-verification" content="googlece17f0a456a89a36.html"> <meta http-equiv="Permissions-Policy" content="interest-cohort=()"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title> Concourrency 2 | Y. Liu </title> <meta name="author" content="Y. Liu"> <meta name="description" content="This is the chapter relating to concurrency control - Part 2."> <meta name="keywords" content="ku, ucph, copenhagen, diku, portfolio-website, liuying, dk, yingliu, ying liu, liu ying"> <link rel="stylesheet" href="/assets/css/bootstrap.min.css?a4b3f509e79c54a512b890d73235ef04"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link defer rel="stylesheet" href="/assets/css/academicons.min.css?f0b7046b84e425c55f3463ac249818f5"> <link defer rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons&amp;display=swap"> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-github.css?591dab5a4e56573bf4ef7fd332894c99" media="" id="highlight_theme_light"> <link defer href="/assets/css/bootstrap-toc.min.css?6f5af0bb9aab25d79b2448143cbeaa88" rel="stylesheet"> <link rel="shortcut icon" href="/assets/img/favicon.png?157bbd74cef60250fd5a67a2e078966e"> <link rel="stylesheet" href="/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://liuying-1.github.io/blog/2023/concurrency-2/"> <script src="/assets/js/theme.js?9a0c749ec5240d9cda97bc72359a72c0"></script> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-native.css?5847e5ed4a4568527aa6cfab446049ca" media="none" id="highlight_theme_dark"> <script>initTheme();</script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.1.0/dist/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js?85ddb88934d28b74e78031fd54cf8308"></script> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script type="text/javascript">window.MathJax={tex:{tags:"ams"}};</script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.min.js" integrity="sha256-rjmgmaB99riUNcdlrDtcAiwtLIojSxNyUFdl+Qh+rB4=" crossorigin="anonymous"></script> <script defer src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6" crossorigin="anonymous"></script> <script src="/assets/js/distillpub/template.v2.js"></script> <script src="/assets/js/distillpub/transforms.v2.js"></script> <script src="/assets/js/distillpub/overrides.js"></script> </head> <body> <d-front-matter> <script async type="text/json">
      {
            "title": "Concourrency 2",
            "description": "This is the chapter relating to concurrency control - Part 2.",
            "published": "January 02, 2023",
            "authors": [
              
              {
                "author": "Ying Liu",
                "authorURL": "https://di.ku.dk/Ansatte/forskere/?pure=da/persons/762476",
                "affiliations": [
                  {
                    "name": "DIKU, UCPH",
                    "url": ""
                  }
                ]
              }
              
            ],
            "katex": {
              "delimiters": [
                {
                  "left": "$",
                  "right": "$",
                  "display": false
                },
                {
                  "left": "$$",
                  "right": "$$",
                  "display": true
                }
              ]
            }
          }
    </script> </d-front-matter> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top" role="navigation"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"> <span class="font-weight-bold">Y.</span> Liu </a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">About </a> </li> <li class="nav-item active"> <a class="nav-link" href="/blog/">Blog </a> </li> <li class="nav-item "> <a class="nav-link" href="/cv/">CV </a> </li> <li class="nav-item"> <button id="search-toggle" title="Search" onclick="openSearchModal()"> <span class="nav-link">Ctrl K <i class="ti ti-search"></i></span> </button> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="ti ti-sun-moon" id="light-toggle-system"></i> <i class="ti ti-moon-filled" id="light-toggle-dark"></i> <i class="ti ti-sun-filled" id="light-toggle-light"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="post distill"> <d-title> <h1>Concourrency 2</h1> <p>This is the chapter relating to concurrency control - Part 2.</p> </d-title> <d-byline></d-byline> <d-article> <d-contents> <nav class="l-text figcaption"> <h3>Contents</h3> <div> <a href="#"></a> </div> </nav> </d-contents> <div align="center"> <div class="row mt-3"> <div class="col-sm mt-3 mt-md-0"> <img src="https://i.imgur.com/NBdawZO.png" alt="Group_8_YhdE3vh" class="img-fluid rounded z-depth-1"> </div> </div> </div> <h2 id="do-it-yourself-recap">Do-it-yourself-recap</h2> <p><strong>Locking Solutions for Isolation in ACID Transactions</strong></p> <ul> <li> <p>Why two phases?</p> <p><em><u>Acquiring phase</u></em> and <em><u>releasing phase</u></em>. What does this give us? The claim from the last lecture is that this will give us serializability. So only schedules that are produced that can be produced by such a mechanism will be serializable.</p> </li> <li> <p>What about the problems with these different strategies? (Solution 4 &amp; Solution 5) How to acquire and release locks? How to structure the two phases?</p> <p>C2PL =&gt; Cascading Aborts, S2PL =&gt; Deadlocks</p> </li> </ul> <h2 id="is-s2pl-correct-assuming-the-database-is-not-dynamic">Is S2PL correct? (Assuming the database is not dynamic)</h2> <p>Strict 2PL can however deadlock =&gt; We will see how to handle deadlock automatically</p> <h2 id="schedules---recap">Schedules -&gt; Recap</h2> <p>What is a schedule?</p> <p>A schedule is a sequence of <code class="language-plaintext highlighter-rouge">READ / WRITE</code> actions that these performed by different transactions.</p> <p>Interleaving is one possible execution of these actions and we allow the transactions to interleave their actions. This is what will give us concurrency but in the schedule, all actions are linearized. <strong>So there are no concurrent actions in a schedule.</strong> <strong><em>!IMPORTANT</em></strong></p> <h2 id="scheduling-transactions---recap">Scheduling Transactions -&gt; Recap</h2> <p><strong>Serial schedule</strong>: Schedule that does not interleave the actions of different transactions.</p> <p><strong>Equivalent schedules</strong>: See <a href="https://liuying-1.github.io/advanced-computer-system/concurrency/">Concurrency Control 1</a></p> <ul> <li>Moreover, we can abstract a way of what the transactions actually do here the actual computational operations just see the <code class="language-plaintext highlighter-rouge">READ</code>s and <code class="language-plaintext highlighter-rouge">WRITE</code>s. So we can not somehow assume anything about what these transactions might do to the state of the system so because we need to require that all the values read by the transactions will be the same in the two transactions. So this encodes the assumption that we abstract away the logic of two of the actual transaction.</li> </ul> <p><strong>Serializable schedule</strong>: <a href="https://liuying-1.github.io/advanced-computer-system/concurrency/">Concurrency Control 1</a></p> <p>So if we have a serializable schedule, this is the kind of core property that helps us achieve why we are interested in serializable schedules. It helps us to reason about consistency. Consistency is not the task of the database management system to provide it somehow application specific but active if your schedules are not serializable, it becomes very hard for the use of a DBMS to think about consistency.</p> <p><strong><em>Note: If each transaction preserves consistency, every serializable schedule preserves consistency.</em></strong></p> <p>Whereas for a serializable schedule, the user can pretend that there is no concurrence in the database system. So if there is a transaction that is consistent without any concurrency, if it’s consistent as if it was executed as the only transaction in the system then also the serializable will preserve consistency.</p> <p>Summary =&gt; We want serializable property that it can preserve consistency.</p> <h2 id="anomalies-with-interleaved-execution">Anomalies with Interleaved Execution</h2> <p>These three are the most typical three.</p> <p><strong>Dirty Reads (WR Conflicts)</strong> =&gt; Read uncommitted Data</p> <p>The first transaction would write the value of A and then the second transaction would execute a Read of A and much later the first transaction with the action aborted for some reason. Then, transaction 2 has a problem because that value should have never been written in the first transaction when the transaction has been aborted, we don’t want to see any of its actions take any effect on the database state.</p> <p><strong>Unrepeatable Reads (RW Conflicts)</strong></p> <p>Here the transaction reads a value and transaction 2 modifies that value and transaction 1 reads that value again. Well, it will be a potentially different value because it has been modified. <strong>Thus this is a bit problematic like the transaction should rely on that when it reads if it is the only transaction running in the system, whatever it reads will not be modified by anyone else. That’s the isolation view that we want to enforce.</strong></p> <p><strong>Overwriting Uncommitted Data (WW Conflicts)</strong></p> <p>Blind Write without reading any values. The last written value for B is the one from transaction 1, and the last written value for A is the one from transaction 2. There is simply no serial execution of this.</p> <p><a href="https://en.wikipedia.org/wiki/Write%E2%80%93write_conflict" rel="external nofollow noopener" target="_blank">WW-Conflicts, Wikipedia</a></p> <h2 id="conflict-serializable-schedules">Conflict Serializable Schedules</h2> <p>Now comes the refinement of this notion of serializability. And this is a very different kind of notion I would say. So while serializability is a semantic notion, it talks about how database state changes across the execution of the schedule. This one is very syntactic. It just looks at which actions are performed and which actions can be easily swapped.</p> <p>We call the schedule conflict serializable if it is conflict equivalent to some serial schedule and now the important part is that conflict equivalent is a different thing. This is not the same as equivalent, this is where the difference between the two definitions lies. =&gt; Introduce the definition of the <strong><em>Conflict</em> <em>Equivalent</em></strong></p> <hr> <p>Two schedules are conflict equivalent if they have the same actions of the same transaction.</p> <p><em>Tip: In equivalent schedules, the serializability doesn’t care about the sequence of the actions, while it does matters in the Conflict Equivalent</em>.</p> <p>Moreover, every pair of conflicting actions should be ordered in the same way. First, what are conflicting actions? Those are the kind of actions that cause troubles =&gt; Conflicts mentioned before. So, two actions are conflicting if they access the same memory location and one of the two is the <code class="language-plaintext highlighter-rouge">Write</code>.</p> <p>For every pair of actions in two schedules, if conflicting actions to schedules, they must occur in the same order in both schedules. So if a <code class="language-plaintext highlighter-rouge">READ</code> to A occurred before a <code class="language-plaintext highlighter-rouge">WRITE</code> to A in one schedule, then it must do so in the second schedule as well.</p> <hr> <p><strong>Official Version</strong></p> <p>Two schedules are conflict equivalent if:</p> <ul> <li>Involve <em><u>the same actions of the same transactions</u></em> </li> <li>Every pair of conflicting actions <em><u>is ordered the same way</u></em> </li> <li>Two actions are called conflicting <em><u>if they access the same object and one of them is a write</u></em> </li> </ul> <p>Schedule S is <u>_conflict serializable_</u> if S <em><u>is conflict equivalent to some serial schedule</u></em>.</p> <h2 id="example-that-is-not-conflict-serializable">Example that is not conflict serializable</h2> <div align="center"> <div class="row mt-3"> <div class="col-sm mt-3 mt-md-0"> <img src="https://i.imgur.com/a2hsLI3.png" alt="image-20230104145627828" style="zoom:33%;" class="img-fluid rounded z-depth-1"> </div> </div> </div> <p>We will build <strong><em><u>Precedence Graph</u></em></strong> to see if there is a cycle. If there is like here for example, then the schedule will not be conflict serializable. If there is not, then the schedule will be conflict serializable. There is an arrow if there is a pair of conflicting operations between the two transactions, and the earlier part of the pair comes from the source of the arrow and the later parties and the target of the arrow.</p> <p><strong>Analysis of the example</strong></p> <p>Conflicts</p> <ol> <li>The very first <code class="language-plaintext highlighter-rouge">READ</code> conflicts with the <code class="language-plaintext highlighter-rouge">WRITE</code> =&gt; <code class="language-plaintext highlighter-rouge">T1: R(A)</code> -&gt; <code class="language-plaintext highlighter-rouge">T2: W(A)</code>. And because it occurs in the schedule before the <code class="language-plaintext highlighter-rouge">WRITE</code>, that’s the reason why there is an arrow from <code class="language-plaintext highlighter-rouge">T1</code> to <code class="language-plaintext highlighter-rouge">T2</code>.</li> <li> <code class="language-plaintext highlighter-rouge">T1: W(A)</code>, <code class="language-plaintext highlighter-rouge">T2: R(A)</code> is the case of dirty reads, and also <code class="language-plaintext highlighter-rouge">T1: W(A)</code> conflicts with <code class="language-plaintext highlighter-rouge">T2: W(A)</code>. And shares the same arrow with conflict 1 as they are all caused by <code class="language-plaintext highlighter-rouge">T1</code>.</li> <li> <code class="language-plaintext highlighter-rouge">T2: R(B)</code> conflicts with <code class="language-plaintext highlighter-rouge">T1: W(B)</code>, and <code class="language-plaintext highlighter-rouge">T2: W(B)</code> conflicts with <code class="language-plaintext highlighter-rouge">T1: R(B)</code>. Hence, there is a back edge arrow.</li> </ol> <font face="宋体" color="red">在这个例子里，我不太理解为什么第一个冲突会是RW冲突，因为T1并没有继续重复读取A的值（已解决，看Recap中关于RW标粗的定义）。同时我也不太能理解为什么第二个里面会有WW冲突，因为和上面的WW冲突的定义不符合；</font> <h2 id="precedence-graph">Precedence Graph</h2> <p>One node per transaction; edge from <code class="language-plaintext highlighter-rouge">Ti</code> to <code class="language-plaintext highlighter-rouge">Tj</code> if an operation in <code class="language-plaintext highlighter-rouge">Tj</code> conflicts with an earlier operation in <code class="language-plaintext highlighter-rouge">Ti</code>.</p> <div align="center"><i><b>Theorem: Schedule is conflict serializable if and only if its precedence graph is acyclic. (1)</b></i></div> <div align="center"><i><b>Theorem: Strict 2PL only results in conflict serializable schedules. (2)</b></i></div> <p>Hence, S2PL only gives us conflict serializable schedules.</p> <h2 id="exercises">Exercises</h2> <p>Are the following schedules conflict serializable?</p> <table> <thead> <tr> <th style="text-align: center">T1</th> <th style="text-align: center">R(A)</th> <th style="text-align: center"> </th> <th style="text-align: center"> </th> <th style="text-align: center">W(B)</th> <th style="text-align: center"> </th> <th style="text-align: center"> </th> <th style="text-align: center"> </th> <th style="text-align: center">C</th> <th style="text-align: center"> </th> <th style="text-align: center"> </th> </tr> </thead> <tbody> <tr> <td style="text-align: center">T2</td> <td style="text-align: center"> </td> <td style="text-align: center">R(B)</td> <td style="text-align: center"> </td> <td style="text-align: center"> </td> <td style="text-align: center">R(A)</td> <td style="text-align: center"> </td> <td style="text-align: center">R(C)</td> <td style="text-align: center"> </td> <td style="text-align: center">C</td> <td style="text-align: center"> </td> </tr> <tr> <td style="text-align: center">T3</td> <td style="text-align: center"> </td> <td style="text-align: center"> </td> <td style="text-align: center">R(B)</td> <td style="text-align: center"> </td> <td style="text-align: center"> </td> <td style="text-align: center">W(C)</td> <td style="text-align: center"> </td> <td style="text-align: center"> </td> <td style="text-align: center"> </td> <td style="text-align: center">C</td> </tr> </tbody> </table> <p>Yes. This is conflict serializable.</p> <table> <thead> <tr> <th style="text-align: center">T1</th> <th style="text-align: center">R(A)</th> <th style="text-align: center"> </th> <th style="text-align: center">W(B)</th> <th style="text-align: center"> </th> <th style="text-align: center"> </th> <th style="text-align: center"> </th> <th style="text-align: center"> </th> <th style="text-align: center">C</th> <th style="text-align: center"> </th> <th style="text-align: center"> </th> </tr> </thead> <tbody> <tr> <td style="text-align: center">T2</td> <td style="text-align: center"> </td> <td style="text-align: center">R(B)</td> <td style="text-align: center"> </td> <td style="text-align: center"> </td> <td style="text-align: center">R(A)</td> <td style="text-align: center"> </td> <td style="text-align: center">R(C)</td> <td style="text-align: center"> </td> <td style="text-align: center">C</td> <td style="text-align: center"> </td> </tr> <tr> <td style="text-align: center">T3</td> <td style="text-align: center"> </td> <td style="text-align: center"> </td> <td style="text-align: center"> </td> <td style="text-align: center">R(B)</td> <td style="text-align: center"> </td> <td style="text-align: center">W(C)</td> <td style="text-align: center"> </td> <td style="text-align: center"> </td> <td style="text-align: center"> </td> <td style="text-align: center">C</td> </tr> </tbody> </table> <p>No, as there is a cycle in the Precedence Graph.</p> <p><strong><em>The above are my own solutions, I am not sure whether they are correct right now.</em></strong></p> <font color="red">We need to pay attention to the direction of the graph. And there is no need to think about commit action.</font> <h2 id="returning-to-definition-of-serializability">Returning to Definition of Serializability</h2> <p>A schedule S is serializable if there exists a serial order SO such that:</p> <ul> <li>The <strong>state of the database</strong> after S is the <strong>same</strong> as the state of the database after SO</li> <li>The <strong>values read</strong> by each transaction in S are the <strong>same</strong> as that returned by each transaction in SO <ul> <li>Database does not know anything about the internal structure of the transaction programs</li> </ul> </li> </ul> <p><strong>Under this definition, certain serializable executions are not conflict serializable!</strong></p> <h2 id="example-to-show-the-scope-for-conflict-serializable-is-tighter">Example to show the scope for conflict serializable is tighter</h2> <table> <thead> <tr> <th style="text-align: center">T1</th> <th style="text-align: center">R(A)</th> <th style="text-align: center"> </th> <th style="text-align: center">W(A)</th> <th style="text-align: center"> </th> </tr> </thead> <tbody> <tr> <td style="text-align: center">T2</td> <td style="text-align: center"> </td> <td style="text-align: center">W(A)</td> <td style="text-align: center"> </td> <td style="text-align: center"> </td> </tr> <tr> <td style="text-align: center">T3</td> <td style="text-align: center"> </td> <td style="text-align: center"> </td> <td style="text-align: center"> </td> <td style="text-align: center">W(A)</td> </tr> </tbody> </table> <p>Is this schedule serializable? <font color="red">How to judge whether the schedule is serializable?</font></p> <p>Yes, the equivalent schedule is below.</p> <table> <thead> <tr> <th style="text-align: center">T1</th> <th style="text-align: center">R(A)</th> <th style="text-align: center">W(A)</th> <th style="text-align: center"> </th> <th style="text-align: center"> </th> </tr> </thead> <tbody> <tr> <td style="text-align: center">T2</td> <td style="text-align: center"> </td> <td style="text-align: center"> </td> <td style="text-align: center">W(A)</td> <td style="text-align: center"> </td> </tr> <tr> <td style="text-align: center">T3</td> <td style="text-align: center"> </td> <td style="text-align: center"> </td> <td style="text-align: center"> </td> <td style="text-align: center">W(A)</td> </tr> </tbody> </table> <p>However, is this schedule conflict serializable?</p> <p>No, as there is a cycle between <code class="language-plaintext highlighter-rouge">T1</code> and <code class="language-plaintext highlighter-rouge">T2</code>.</p> <p><em>Hence, it is serializable but not conflict serializable.</em></p> <h2 id="view-serializability">View Serializability</h2> <p>There is kind of an alternative that sits between conflicts serializable and serializable, view serializable.</p> <p>A schedule is <em>view serializable</em> if it is view equivalent to a serial schedule. Here is a new term, view equivalent.</p> <hr> <p>Schedules S1 and S2 are <strong>view equivalent</strong> if:</p> <ul> <li> <p>If <code class="language-plaintext highlighter-rouge">Ti</code> reads initial value of <code class="language-plaintext highlighter-rouge">A</code> in <code class="language-plaintext highlighter-rouge">S1</code>, then <code class="language-plaintext highlighter-rouge">Ti</code> also reads initial value of <code class="language-plaintext highlighter-rouge">A</code> in <code class="language-plaintext highlighter-rouge">S2</code>. =&gt; Initial Read</p> </li> <li> <p>If <code class="language-plaintext highlighter-rouge">Ti</code> reads value of <code class="language-plaintext highlighter-rouge">A</code> written by <code class="language-plaintext highlighter-rouge">Tj</code> in <code class="language-plaintext highlighter-rouge">S1</code>, then <code class="language-plaintext highlighter-rouge">Ti</code> also reads value of <code class="language-plaintext highlighter-rouge">A</code> written by <code class="language-plaintext highlighter-rouge">Tj</code> in <code class="language-plaintext highlighter-rouge">S2</code> =&gt; Any Read happens Later</p> </li> <li> <p>If <code class="language-plaintext highlighter-rouge">Ti</code> writes final value of <code class="language-plaintext highlighter-rouge">A</code> in <code class="language-plaintext highlighter-rouge">S1</code>, then <code class="language-plaintext highlighter-rouge">Ti</code> also writes final value of <code class="language-plaintext highlighter-rouge">A</code> in <code class="language-plaintext highlighter-rouge">S2.</code></p> </li> </ul> <div align="center"> <div class="row mt-3"> <div class="col-sm mt-3 mt-md-0"> <img src="https://i.imgur.com/hU9XTKV.png" alt="image-20230104164137815" style="zoom:33%;"> </div> </div> </div> <div align="center"> <div class="row mt-3"> <div class="col-sm mt-3 mt-md-0"> <img src="https://i.imgur.com/cGIZt1C.png" alt="image-20230104174522681" style="zoom:33%;" class="img-fluid rounded z-depth-1"> </div> </div> </div> <p><a href="https://hw311.me/zh/study-notes/database/2019/02/24/transaction-consistency-serializability/" rel="external nofollow noopener" target="_blank">Reference about View Serializable</a></p> <h2 id="deadlocks">Deadlocks</h2> <p>When we use S2PL, we can get into a deadlocks, and what is the deadlock?</p> <p><strong><em>Deadlock: Cycle of transactions waiting for locks to be released by each other. Hold the locks that are required for the other transaction to proceed.</em></strong></p> <p>We have two ways dealing with deadlocks.</p> <p>One is <strong><em>Deadlock Prevention</em></strong> that will <em>ensure that no cycle will happen</em>. When taking locks, we will decide what to do with transactions and we will abort those that would cause a cycle to arise. (Before)</p> <p>The second is <strong><em>Deadlock Detection</em></strong>, in this strategy, we don’t do the same as the first one. We only always monitor who is waiting for whom, looking if there are cycles. And only when the cycle is there, then, we start aborting transactions. (Arise)</p> <p><a href="https://github.com/CyC2018/CS-Notes/blob/master/notes/%E8%AE%A1%E7%AE%97%E6%9C%BA%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%20-%20%E6%AD%BB%E9%94%81.md#%E6%AD%BB%E9%94%81%E9%A2%84%E9%98%B2" rel="external nofollow noopener" target="_blank"><font face="songti">死锁预防｜死锁检测</font></a></p> <h2 id="deadlock-prevention">Deadlock Prevention</h2> <p>How to prevent deadlocks? The basic idea is to assign certain priorities or weights to our transactions and one good strategy is to use <strong><em>timestamps</em></strong>.</p> <p>The idea is that the oldest transaction should get the higher priority somehow the transaction that needs to wait longer to execute should get priority over more recent transactions.</p> <p>Hence, we,</p> <ul> <li> <p>Assign priorities based on <strong><em><u>timestamps</u></em></strong>.</p> </li> <li> <p>Lower timestamps get higher priority, i.e., older transactions get prioritized.</p> </li> <li> <p>Assume <code class="language-plaintext highlighter-rouge">Ti</code> wants a lock that <code class="language-plaintext highlighter-rouge">Tj</code> holds. Two policies are possible (alternatives).</p> <ul> <li> <p>Wait-Die: <strong>If <code class="language-plaintext highlighter-rouge">Ti</code> has higher priority</strong>, <strong><code class="language-plaintext highlighter-rouge">Ti</code> waits for <code class="language-plaintext highlighter-rouge">Tj</code>; otherwise <code class="language-plaintext highlighter-rouge">Ti</code> aborts</strong>. =&gt; <code class="language-plaintext highlighter-rouge">Ti</code> should wait that it has higher priority but it still needs to wait because the lock has been held by <code class="language-plaintext highlighter-rouge">Tj</code> and we want to wait for <code class="language-plaintext highlighter-rouge">Tj</code> to finish its execution, but we also do not want to abort <code class="language-plaintext highlighter-rouge">Ti</code> because it has higher priority. Hence, that is the decision to let <code class="language-plaintext highlighter-rouge">Ti</code> wait. If <code class="language-plaintext highlighter-rouge">Ti</code> does not have higher priority, we abort with <code class="language-plaintext highlighter-rouge">Ti</code>.</p> <p>=&gt; 如果A的优先权为1，B的优先权为2。此时，如果A向B要锁，A的权限更高，然后A就等，因为A的生存时间更久；如果此时B也正好要A的锁，则B abort，否则造成死锁。</p> </li> <li> <p>Wound-wait: <strong>If <code class="language-plaintext highlighter-rouge">Ti</code> has higher priority</strong>, <strong><code class="language-plaintext highlighter-rouge">Tj</code> aborts; otherwise <code class="language-plaintext highlighter-rouge">Ti</code> waits</strong>.</p> <p>=&gt; 同样的例子，优先级高的永远在要锁的时候能抢到锁，优先级低的直接abort。</p> </li> </ul> </li> <li> <p>If a transaction re-starts, make sure it has its original timestamp.</p> </li> </ul> <h2 id="deadlock-detection">Deadlock Detection</h2> <p>When this graph has a cycle, then we start getting active and start killing transactions.</p> <ul> <li>Create a <strong>waits-for graph</strong>: <ul> <li>Nodes are transactions</li> <li>There is an edge from <code class="language-plaintext highlighter-rouge">Ti</code> to <code class="language-plaintext highlighter-rouge">Tj</code> if <code class="language-plaintext highlighter-rouge">Ti</code> is waiting for <code class="language-plaintext highlighter-rouge">Tj</code> to release a lock =&gt; Different from the <strong><em>Precedence Graph</em></strong> </li> </ul> </li> <li>Periodically check for cycles in the waits-for graph =&gt; Maybe we don’t need to detect the deadlocks as soon as they arise, but at some point, we would like to detect them.</li> </ul> <h2 id="example-of-deadlock-detection">Example of Deadlock Detection</h2> <table> <thead> <tr> <th style="text-align: center">T1</th> <th style="text-align: center">S(A)</th> <th style="text-align: center">R(A)</th> <th style="text-align: center"> </th> <th style="text-align: center"> </th> <th style="text-align: center">S(B)</th> <th style="text-align: center"> </th> <th style="text-align: center"> </th> <th style="text-align: center"> </th> <th style="text-align: center"> </th> <th style="text-align: center"> </th> </tr> </thead> <tbody> <tr> <td style="text-align: center">T2</td> <td style="text-align: center"> </td> <td style="text-align: center"> </td> <td style="text-align: center">X(B)</td> <td style="text-align: center">W(B)</td> <td style="text-align: center"> </td> <td style="text-align: center"> </td> <td style="text-align: center"> </td> <td style="text-align: center">X(C)</td> <td style="text-align: center"> </td> <td style="text-align: center"> </td> </tr> <tr> <td style="text-align: center">T3</td> <td style="text-align: center"> </td> <td style="text-align: center"> </td> <td style="text-align: center"> </td> <td style="text-align: center"> </td> <td style="text-align: center"> </td> <td style="text-align: center">S(C)</td> <td style="text-align: center">R(C)</td> <td style="text-align: center"> </td> <td style="text-align: center"> </td> <td style="text-align: center"><font color="red">X(A)</font></td> </tr> <tr> <td style="text-align: center">T4</td> <td style="text-align: center"> </td> <td style="text-align: center"> </td> <td style="text-align: center"> </td> <td style="text-align: center"> </td> <td style="text-align: center"> </td> <td style="text-align: center"> </td> <td style="text-align: center"> </td> <td style="text-align: center"> </td> <td style="text-align: center">X(B)</td> <td style="text-align: center"> </td> </tr> </tbody> </table> <div align="center"> <div class="row mt-3"> <div class="col-sm mt-3 mt-md-0"> <img src="https://i.imgur.com/h6gORNH.png" alt="image-20230104182841732" style="zoom:33%;" class="img-fluid rounded z-depth-1"> </div> </div> </div> <p>In the example above, when <code class="language-plaintext highlighter-rouge">T1</code> would like to <code class="language-plaintext highlighter-rouge">R(B)</code>, it first gets a shared lock for B, however, it needs to wait for T2 to release the exclusive lock. Hence, <code class="language-plaintext highlighter-rouge">T1</code> to <code class="language-plaintext highlighter-rouge">T2</code>. The others are the same.</p> <p>The right part for <code class="language-plaintext highlighter-rouge">X(A)</code> is in red because this is the operation close the cycle and eventually detects that there is a cycle and decides which transaction to abort. Once we have a cycle, we need to abort one of the involved transactions. =&gt; Abort 1, 2, 3 哪个都行</p> <div align="center"> <div class="row mt-3"> <div class="col-sm mt-3 mt-md-0"> <img src="https://i.imgur.com/nj9nRGn.png" alt="image-20230104184008200" style="zoom:50%;" class="img-fluid rounded z-depth-1"> </div> </div> </div> <p><a href="https://www.inlighting.org/archives/database-concurrency-control" rel="external nofollow noopener" target="_blank">REFERENCE</a></p> <h2 id="practices-waits-for">Practices Waits-for</h2> <table> <thead> <tr> <th style="text-align: center">T1</th> <th style="text-align: center">S(A)</th> <th style="text-align: center"> </th> <th style="text-align: center"> </th> <th style="text-align: center">X(D)</th> <th style="text-align: center"> </th> <th style="text-align: center">X(C)</th> <th style="text-align: center">C</th> <th style="text-align: center"> </th> <th style="text-align: center"> </th> </tr> </thead> <tbody> <tr> <td style="text-align: center">T2</td> <td style="text-align: center"> </td> <td style="text-align: center"> </td> <td style="text-align: center">X(A)</td> <td style="text-align: center"> </td> <td style="text-align: center"> </td> <td style="text-align: center"> </td> <td style="text-align: center"> </td> <td style="text-align: center">X(B)</td> <td style="text-align: center"> </td> </tr> <tr> <td style="text-align: center">T3</td> <td style="text-align: center"> </td> <td style="text-align: center">S(B)</td> <td style="text-align: center"> </td> <td style="text-align: center"> </td> <td style="text-align: center"> </td> <td style="text-align: center"> </td> <td style="text-align: center"> </td> <td style="text-align: center"> </td> <td style="text-align: center">S(C)</td> </tr> </tbody> </table> <p>Note: We only show locking operations for brevity! C alone denotes commit, <strong><u>all locks released</u></strong></p> <p>There is no deadlock.</p> <p><strong><em>Notice: We need to delete the arrow from T2 to T1 as soon as the locks are released by T1.</em></strong></p> <table> <thead> <tr> <th style="text-align: center">T1</th> <th style="text-align: center"> </th> <th style="text-align: center"> </th> <th style="text-align: center"> </th> <th style="text-align: center">S(C)</th> <th style="text-align: center">S(A)</th> <th style="text-align: center"> </th> <th style="text-align: center">X(D)</th> </tr> </thead> <tbody> <tr> <td style="text-align: center">T2</td> <td style="text-align: center">S(B)</td> <td style="text-align: center"> </td> <td style="text-align: center"> </td> <td style="text-align: center"> </td> <td style="text-align: center"> </td> <td style="text-align: center">X(C)</td> <td style="text-align: center"> </td> </tr> <tr> <td style="text-align: center">T3</td> <td style="text-align: center"> </td> <td style="text-align: center">S(D)</td> <td style="text-align: center">X(B)</td> <td style="text-align: center"> </td> <td style="text-align: center"> </td> <td style="text-align: center"> </td> <td style="text-align: center"> </td> </tr> </tbody> </table> <p>There is a deadlock.</p> <p><strong><em>Here the contents above are something about lockful approaches for concurrency control. Let’s talk about lockless approaches.</em></strong></p> <h2 id="the-problems-with-locking">The Problems with Locking</h2> <p>Locking is a <strong>pessimistic</strong> (Prepare yourself for the rest to happen) approach in which conflicts are prevented. Disadvantages:</p> <ul> <li>Lock management overhead =&gt; There is a certain overhead coming for managing the locks. We need to deal with deadlocks.</li> <li>Deadlock detection/resolution</li> <li>Lock contention for heavily used objects =&gt; if you have objects that are very heavily accessed read or written, there will be some lock contention for the objects.</li> </ul> <p>But what we will be looking right now is a more <strong>optimistic</strong> approach. Just let things happen and if bad things happen, you try to resolve them without using locks.</p> <p>However, even if we were to give up locking, we still wanted to enforce some form of serializibility without requiring the entire schedule to be completely serial, so without destroying concurrency.</p> <p>We will look at how to <strong><em>repair violations</em></strong> when they happen by aborting transactions. Locking is used to prevent violations. While <strong><em>aborts</em></strong> is the only method to <strong><em>fix violations</em></strong>.</p> <p><em>How can we design a protocol based on aborts instead of locks?</em></p> <h2 id="optimistic-concurrency-control-kung-robinson-model">Optimistic Concurrency Control: Kung-Robinson Model</h2> <p>The basic idea is, there are no locks, so completely different from before, but the transactions has been structured into 3 different phases.</p> <p><code class="language-plaintext highlighter-rouge">READ</code> =&gt; We have a <code class="language-plaintext highlighter-rouge">READ</code> phase when you read things from the database. We can also write things but not to the database. (You are writing things you are making changes to copies of the objects you read from the database).</p> <p><code class="language-plaintext highlighter-rouge">VALIDATE</code> =&gt; We will talk in detail what the validate phase needs to do to ensure in the end serializability. =&gt; Check for conflicts.</p> <p><code class="language-plaintext highlighter-rouge">WRITE</code> phase where we write out all the local changes that we accumulated, but we are not reading anymore in this phase. We only access database in the <code class="language-plaintext highlighter-rouge">WRITE</code> phase =&gt; Make local copies of changes public.</p> <h2 id="validation-phase">Validation Phase</h2> <p>Test conditions that are <strong>sufficient</strong> to ensure that no conflict occured.</p> <p>Each transaction is assigned a numeric id and just use a <strong>timestamp</strong>.</p> <p>Transaction IDs are assigned at end of <code class="language-plaintext highlighter-rouge">READ</code> phase, just before validation begins. When the transaction is finished with reading then we record that timestamp and say this is the id of the transaction.</p> <p>And then, we need to consider the set of objects read by the given transaction and modified by the transaction. And we call these sets <code class="language-plaintext highlighter-rouge">ReadSet(Ti)</code> and <code class="language-plaintext highlighter-rouge">WriteSet(Ti)</code>.</p> <p>Official =&gt; <code class="language-plaintext highlighter-rouge">ReadSet(Ti)</code>: Set of objects read by transaction <code class="language-plaintext highlighter-rouge">Ti</code>, <code class="language-plaintext highlighter-rouge">WriteSet(Ti)</code>: Set of objects modified by <code class="language-plaintext highlighter-rouge">Ti</code></p> <p>The validation phase proceed the tests and there are <strong><em>three test conditions</em></strong>. If the first test fails, we still have a chance to succeed with the second test and so on.</p> <h2 id="test-1">Test 1</h2> <div align="center"> <div class="row mt-3"> <div class="col-sm mt-3 mt-md-0"> <img src="https://i.imgur.com/YsSDoDX.png" alt="image-20230104213954735" style="zoom:50%;" class="img-fluid rounded z-depth-1"> </div> </div> </div> <p><u>For all i and j such that `Ti` &lt; `Tj`, check that `Ti` completes before `Tj` begins.</u> Ti and Tj are the id of the transactions and also the timestamp after the end of the <code class="language-plaintext highlighter-rouge">READ</code> phase. But <strong><em>if additionlly <code class="language-plaintext highlighter-rouge">Ti</code> has completed doing everything what it was supposed to do before <code class="language-plaintext highlighter-rouge">Tj</code> even started, that’s ok. So then we passed the first test</em></strong> and there is no problem between these two transactions, this is kind of they do not overlap in time. =&gt; Transactions are not executed concurrently.</p> <h2 id="test-2">Test 2</h2> <p>For all i and j such that <code class="language-plaintext highlighter-rouge">Ti</code> &lt; <code class="language-plaintext highlighter-rouge">Tj</code>, check that:</p> <ul> <li> <p><code class="language-plaintext highlighter-rouge">Ti</code> completes before <code class="language-plaintext highlighter-rouge">Tj</code> begins its <code class="language-plaintext highlighter-rouge">WRITE</code> phase</p> </li> <li> <p><code class="language-plaintext highlighter-rouge">WriteSet(Ti)</code> $\and$ <code class="language-plaintext highlighter-rouge">ReadSet(Tj)</code> is empty. =&gt; <code class="language-plaintext highlighter-rouge">Tj</code> does not read dirty data that has been modified by <code class="language-plaintext highlighter-rouge">Ti</code>.</p> </li> </ul> <div align="center"> <div class="row mt-3"> <div class="col-sm mt-3 mt-md-0"> <img src="https://i.imgur.com/iltElnk.png" alt="image-20230104214924137" style="zoom: 50%;" class="img-fluid rounded z-depth-1"> </div> </div> </div> <h2 id="test-3">Test 3</h2> <p>For all i and j such that <code class="language-plaintext highlighter-rouge">Ti</code> &lt; <code class="language-plaintext highlighter-rouge">Tj</code>, check that:</p> <ul> <li> <p>Ti completes <code class="language-plaintext highlighter-rouge">READ</code> phase before <code class="language-plaintext highlighter-rouge">Tj</code> does</p> </li> <li> <p><code class="language-plaintext highlighter-rouge">WriteSet(Ti)</code> $\and$ <code class="language-plaintext highlighter-rouge">ReadSet(Tj)</code> is empty =&gt; whatever <code class="language-plaintext highlighter-rouge">Tj</code> reads is not touched by <code class="language-plaintext highlighter-rouge">Ti</code></p> </li> <li> <p><code class="language-plaintext highlighter-rouge">WriteSet(Ti)</code> $\and$ <code class="language-plaintext highlighter-rouge">WriteSet(Tj)</code> is empty =&gt; <code class="language-plaintext highlighter-rouge">Ti</code> will not overwrite <code class="language-plaintext highlighter-rouge">Tj</code>’s writes.</p> <div align="center"> <div class="row mt-3"> <div class="col-sm mt-3 mt-md-0"> <img src="https://i.imgur.com/tyKYj3r.png" alt="image-20230104215433507" style="zoom:50%;"> </div> </div> </div> </li> </ul> <h2 id="validation-example">Validation Example</h2> <p>Predict whether T3 will be allowed to commit, given the transaction below.</p> <div align="center"> <div class="row mt-3"> <div class="col-sm mt-3 mt-md-0"> <img src="https://i.imgur.com/XwaG6Fe.png" alt="image-20230104215705886" style="zoom:50%;" class="img-fluid rounded z-depth-1"> </div> </div> </div> <p>This is the Optimistic Concurrency Control.</p> <h2 id="overheads-in-optimistic-cc">Overheads in Optimistic CC</h2> <p><strong><em>So, there is a question comes out. Why were we developing this complex algorithms for the 2 phase locking if you can do without locks?</em></strong></p> <p>There is some overhead that also comes in this way of achieving serializability.</p> <ul> <li>Must record read/write acitivity in <code class="language-plaintext highlighter-rouge">ReadSet</code> and <code class="language-plaintext highlighter-rouge">WriteSet</code> per transaction. =&gt; Must create and destory these sets as needed.</li> <li>Must check for conflicts during validation, and must make validated writes “global”. <ul> <li>Critical section (The validation phase is also something that comes with its own overhead and is not allowed to continue executing the transaction writing the parts of the transaction that need to be persisted before all the validation checks have passed) reduces concurrency. =&gt; Even though the validation checks are not computationally very expensive, but it’s still some overhead.</li> <li>Scheme for making writes global can reduce clustering of objects</li> </ul> </li> <li>Optimistic CC restarts Xacts that fail validation as work done so far is wasted; Requires clean-up for the local section for each transaction.</li> </ul> <p>Still, optimistic techniques widely used in software transactional memory (STM), main-memory databases.</p> <h2 id="snapshot-isolation">Snapshot Isolation</h2> <ul> <li>Often databases implement properties that are weaker than serializability, snapshot isolation</li> <li>Snapshot: <ul> <li>Transactions see snapshot as of beginning of their execution</li> <li>First Committer Wins: Conflicting writes to same item lead to aborts</li> </ul> </li> <li>May lead to <strong>write skew</strong> <ul> <li>Databse must have at least one doctor on call</li> <li>Two doctors on call concurrently examine snapshot and see exactly each other on call</li> <li>Doctors update their own records to being on leave <ul> <li>No write-write conflicts: different records!</li> </ul> </li> </ul> </li> <li>After commits, database has no doctors on call</li> </ul> <h2 id="examples-of-transaction-support-in-databases-by-using-snapshot">Examples of Transaction Support in Databases by using Snapshot</h2> <h2 id="what-should-we-learn-today">What should we learn today?</h2> <ul> <li>Discuss the definition of serializability and the notion of anomalies</li> <li>Apply the conflict-serializability test using a precedence graph to transaction schedules</li> <li>Discuss the difference between conflict-serializability and view-serializability</li> <li>Explain deadlock prevention and detection techniques</li> <li>Apply deadlock detection using a waits-for graph to transaction schedules</li> <li>Explain the optimistic concurrency control model</li> <li>Predict validation decisions under optimistic concurrency control</li> </ul> </d-article> <d-appendix> <d-footnote-list></d-footnote-list> <d-citation-list></d-citation-list> </d-appendix> <d-bibliography src="/assets/bibliography/"></d-bibliography> </div> <footer class="fixed-bottom" role="contentinfo"> <div class="container mt-0"> © Copyright 2024 Y. Liu. Powered by <a href="https://jekyllrb.com/" target="_blank" rel="external nofollow noopener">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio" rel="external nofollow noopener" target="_blank">al-folio</a> theme. Hosted by <a href="https://pages.github.com/" target="_blank" rel="external nofollow noopener">GitHub Pages</a>. </div> </footer> <script src="/assets/js/bootstrap.bundle.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script async src="https://www.googletagmanager.com/gtag/js?id=G-JC70RZ57BT"></script> <script>function gtag(){window.dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-JC70RZ57BT");</script> <script type="text/javascript">function progressBarSetup(){"max"in document.createElement("progress")?(initializeProgressElement(),$(document).on("scroll",function(){progressBar.attr({value:getCurrentScrollPosition()})}),$(window).on("resize",initializeProgressElement)):(resizeProgressBar(),$(document).on("scroll",resizeProgressBar),$(window).on("resize",resizeProgressBar))}function getCurrentScrollPosition(){return $(window).scrollTop()}function initializeProgressElement(){let e=$("#navbar").outerHeight(!0);$("body").css({"padding-top":e}),$("progress-container").css({"padding-top":e}),progressBar.css({top:e}),progressBar.attr({max:getDistanceToScroll(),value:getCurrentScrollPosition()})}function getDistanceToScroll(){return $(document).height()-$(window).height()}function resizeProgressBar(){progressBar.css({width:getWidthPercentage()+"%"})}function getWidthPercentage(){return getCurrentScrollPosition()/getDistanceToScroll()*100}const progressBar=$("#progress");window.onload=function(){setTimeout(progressBarSetup,50)};</script> <script src="/assets/js/vanilla-back-to-top.min.js?f40d453793ff4f64e238e420181a1d17"></script> <script>addBackToTop();</script> </body> </html>